---
title: "Cookie의 domain 속성과 localhost에서 사용 시 주의사항"
description: "localhost에서는 cookie의 domain 속성이 무시될 수 있는 이유(RFC 6265)를 정리하고, hosts 설정으로 로컬 서브도메인 테스트 환경을 구성하는 방법을 소개합니다."
date: "2023-10-31"
tags: ["frontend", "cookie", "http", "localhost"]
slug: "cookie-domain-localhost"
coverImage: "/images/posts/cookie-domain-localhost/cover.webp"
---

![커버 이미지](/images/posts/cookie-domain-localhost/cover.webp)

## 서론

기존 프로젝트에서 서브도메인을 도입하면서, `localStorage`가 서브도메인 간에 공유되지 않아 저장소를 `localStorage`에서 cookie로 옮기는 작업을 진행했습니다. 그런데 cookie의 도메인 설정이 호스팅 중인 개발 서버에서는 잘 적용되는데, 로컬 환경에서만 적용되지 않는 문제가 있었습니다. 확인해보니 원인은 `localhost`라는 주소 자체에 있었습니다.

## 쿠키에 도메인 설정 방법

개발할 때 로컬 환경에서 먼저 테스트해보고 이상이 없으면 개발/운영 환경에 반영하는 경우가 많습니다. 이때 주소로 `localhost`를 많이 사용하는데, `localhost`에서 cookie의 `domain`을 설정할 때 보통 아래처럼 동작할 것이라고 생각하기 쉽습니다.

```javascript
// HTML 쿠키 설정
document.cookie = "name=Kim";
```

![쿠키 설정1](/images/posts/cookie-domain-localhost/image1.png)

위 JavaScript 코드는 키가 `name`, 값이 `Kim`인 cookie를 설정하라는 의미입니다. 결과는 사진처럼 개발자 도구의 Application 탭에서 확인할 수 있습니다.

```javascript
// localhost와 그 하위도메인의 쿠키 설정
document.cookie = "name=Kim;domain=localhost";
```

![쿠키 설정2](/images/posts/cookie-domain-localhost/image2.png)

그렇다면 `m.localhost`와 `localhost`처럼 도메인이 같은 여러 주소들 간에 cookie를 공유해야 할 때는 어떻게 해야 할까요? [MDN 문서](https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie)에서는 위 코드처럼 `domain` 속성을 사용하라고 안내하고 있습니다.

![쿠키 설정3](/images/posts/cookie-domain-localhost/image3.png)

하지만 `m.localhost`처럼 서브도메인 주소에서 cookie를 확인해보면, 값이 존재하지 않는 것을 볼 수 있습니다. HTTP 상태 관리 메커니즘을 다루는 [RFC 6265](https://www.rfc-editor.org/rfc/rfc6265)를 보면 그 이유를 이해할 수 있는데요. [Section 5.3.6](https://www.rfc-editor.org/rfc/rfc6265#section-5.3)에 따르면 `domain` 속성 값이 규칙에 부합하지 않으면, cookie 생성 요청을 완전히 무시합니다. 도메인 규칙은 [Section 5.1.3](https://www.rfc-editor.org/rfc/rfc6265#section-5.1.3)에서 확인할 수 있습니다.

![도메인 규칙](/images/posts/cookie-domain-localhost/image4.png)

도메인 규칙은 아래 3가지를 모두 만족해야 합니다.

1. 도메인 문자열은 문자열의 접미사일 것
2. 문자열에 포함되지 않은 마지막 문자 도메인 문자열은 %x2E(".") 문자일 것
3. 문자열은 호스트 이름일 것(예: IP 주소가 아님)

`localhost`는 접두사/접미사 구분이 없고 `"."`도 없습니다. 따라서 위 도메인 규칙에 어긋나기 때문에 cookie가 생성되지 않았던 것입니다.

## 해결 방안

`127.0.0.1`은 자기 자신을 가리키는 주소입니다. `localhost`는 `127.0.0.1`의 도메인 네임이며, 이를 도메인 규칙에 맞는 다른 호스트명으로 변경하면 cookie의 `domain` 속성에 정상적으로 사용할 수 있습니다.

가장 간단한 방법은 `hosts` 파일을 수정하는 것입니다. `hosts` 파일은 Windows의 경우 `C:\\Windows\\System32\\drivers\\etc\\hosts`, macOS의 경우 `/private/etc/hosts`에 위치합니다. 파일을 텍스트 에디터로 열어 아래 항목을 추가한 뒤 저장해주시면 됩니다.

```bash
127.0.0.1       localhost.com
127.0.0.1       m.localhost.com
```

저는 위 두 개의 주소만 사용할 예정이라 두 줄만 추가했습니다. 그리고 cookie 설정도 아래처럼 변경합니다.

```javascript
// HTML 쿠키 설정
document.cookie = "name=Kim;domain=localhost.com";
```

![쿠키 설정4](/images/posts/cookie-domain-localhost/image5.png)

![쿠키 설정5](/images/posts/cookie-domain-localhost/image6.png)

`localhost.com`와 `m.localhost.com`으로 접속했을 때 cookie가 정상적으로 공유되는 것을 확인할 수 있습니다.

다만 이 방식으로 로컬 도메인을 바꾸면, API를 호출할 때 origin이 달라져 CORS 오류가 발생할 수 있습니다. 따라서 백엔드 쪽에서도 origin 허용 목록에 `localhost.com`, `m.localhost.com`을 추가해주셔야 정상적으로 개발할 수 있습니다.

> ※ API 사용 시 참고  
> API 호출 시 CORS 오류가 발생한다면, 서버의 origin 예외 처리 항목에 `localhost.com`, `m.localhost.com`을 추가해주셔야 합니다.
