---
title: "setInterval 함수와 타이머 이슈"
description: "브라우저가 유휴 상태일 때 `setInterval`이 지연되어 타이머가 어긋나는 문제를 재현하고, focus 이벤트 기반으로 만료 시간을 재계산하는 방식으로 대응한 과정을 정리합니다."
date: "2023-08-17"
tags: ["javascript", "react"]
slug: "setinterval-timer-issues"
coverImage: "/images/posts/setinterval-timer-issues/cover.jpg"
---

<img
  src="/images/posts/setinterval-timer-issues/cover.jpg"
  style={{ maxWidth: "420px" }}
  alt="커버 이미지"
/>

프론트엔드에서 본인 인증 페이지를 작업 중인데, 본인 인증 요청 후 브라우저에 표시되는 인증 만료 시간과 서버에서 체크하는 인증 만료 시간이 일치하지 않는 문제가 발생했습니다. 처음에는 서버 쪽 이슈라고 생각했지만, 테스트 결과 브라우저가 유휴 상태가 될 때 두 시간이 어긋나는 것을 확인할 수 있었습니다.

창을 최소화하거나 다른 탭으로 이동한 뒤 일정 시간이 지나면 브라우저가 유휴 상태로 진입하는데, 이때 `JavaScript`의 `setInterval`이 지연되는 것이 원인이었습니다.

## setInterval 함수란?

특정 코드를 일정 시간 간격으로 반복 실행할 때 사용하는 함수입니다. `setTimeout`과의 차이점은 한 번만 실행하느냐, 반복 실행하느냐입니다.

`setInterval`은 첫 번째 인자로 실행할 함수를, 두 번째 인자로 반복 주기(ms)를 받으며, 반환 값으로 id를 돌려줍니다.

```jsx
// 1000ms마다 "안녕하세요." 라는 문구를 출력한다.
setInterval(() => {
  console.log("안녕하세요.");
}, 1000);
```

반복을 종료하려면 `clearInterval`에 `setInterval`의 반환 값(id)을 넣어 호출하면 됩니다. 컴포넌트가 언마운트되거나 페이지 전환이 일어나는 등 더 이상 타이머가 필요하지 않은 경우에는 메모리 누수 방지를 위해 `clearInterval`을 반드시 호출해주셔야 합니다.

```jsx
let intervalId = 0;

// id값을 별도의 변수에 저장
intervalId = setInterval(() => {
  console.log("안녕하세요.");
}, 1000);

...

// 저장한 id값을 인자로 넣어서 함수를 호출한다.
clearInterval(intervalId);

```

## 해결 과정

해당 문제를 보완하는 라이브러리도 있어 검토해봤지만, 브라우저가 유휴 상태일 때도 강제로 타이머를 돌리는 방식이라 메모리 누수 같은 사이드 이펙트가 발생할 가능성이 높았습니다. 따라서 별도 라이브러리를 사용하지 않고, 브라우저 탭이 다시 focus될 때마다 인증 만료 시간을 재계산하도록 구현하기로 했습니다.

```jsx
let startTime = 0; // 타이머 시작 시간
let seconds = 0; // 브라우저에 표시할 시간
let intervalId = 0; // setInterval 함수의 반환 값을 저장할 변수

// 타이머 시작 함수
const startTimer = () => {
  startTime = Math.floor(Date.now() / 1000);

  // 현재 시간과 타이머 시작 시간을 비교합니다.
  seconds = Math.floor(Date.now() / 1000) - startTime.current;

  intervalId = setInterval(() => {
    setTimer((prev) => prev + 1);
  }, 1000);
};

// 타이머 종료 함수
const stopTimer = () => {
  clearInterval(intervalId);
  seconds = 0;
  intervalId = 0;
};
```

타이머 시작/종료 함수를 만든 뒤, 아래 코드처럼 브라우저가 focus될 때 사용할 이벤트를 등록합니다. 또한 페이지를 빠져나가는 시점에 등록된 이벤트를 해제해주셔야 합니다.

```jsx
// 브라우저 focus in 이벤트 등록
window.addEventListener("focus", () => {
	clearInterval(intervalId);
	// 타이머 재시작
	startTimer();
});

...

// 페이지를 빠져나갈 때 등록된 이벤트를 제거한다.
window.removeEventListener("focus", null);
```

필요하신 분들을 위해 `React`로 구현한 샘플 코드를 아래에 남겨두겠습니다.

## 샘플 코드

[github 저장소 이동](https://github.com/MochaChoco/set-interval)

## 참고 자료

- [자바스크립트의 setTimeout()과 setInterval() 함수](https://www.daleseo.com/js-timer/)
- [[JavaScript] setTimeout과 setInterval은 정확한 시간을 보장하지 않는다!](https://ssocoit.tistory.com/249#1._%EA%B7%B8%EB%9E%98%EC%84%9C_%EB%AD%90%EA%B0%80_%EB%AC%B8%EC%A0%9C%EC%9D%B8%EB%8D%B0?)
- [react로 setInterval을 사용할 때 겪을 수 있는 문제들](https://pottatt0.tistory.com/36)
