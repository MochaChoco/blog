---
title: "watch와 watchEffect에 대한 고찰"
description: "Vue 3 Composition API의 `watch`와 `watchEffect`가 언제 실행되고 무엇을 추적하는지, 그리고 `immediate` 옵션을 포함한 사용 기준을 정리합니다."
date: "2023-08-28"
tags: ["vue"]
slug: "watch-watcheffect"
coverImage: "/images/posts/watch-watcheffect/cover.png"
---

<img
  src="/images/posts/watch-watcheffect/cover.png"
  style={{ maxWidth: "420px" }}
  alt="커버 이미지"
/>

Vue 3 프로젝트에서 현재 route 경로가 변할 때마다 다른 alert를 띄우는 기능을 개발 중이었는데, 웹사이트 내부 경로가 바뀔 때는 alert가 잘 떴지만 처음 진입 시에만 alert가 뜨지 않는 이슈를 발견했습니다.

```jsx
// main page
<script setup lang="ts">
const route = useRoute();

// 페이지 진입시 동작하지 않음
watch([route], (oldValue, newValue) => {
	window.alert(`현재 위치는 ${route.path}입니다.`);
})
</script>
```

원인은 `watch`가 웹사이트 처음 진입 시점에는 동작하지 않는다는 점이었고, `watch`를 `watchEffect`로 변경하니 그제서야 alert가 정상적으로 출력되었습니다. 이번 글에서는 `watch`와 `watchEffect`의 차이점을 정리해보겠습니다.

## watch와 watchEffect란?

`watch`와 `watchEffect`는 Vue 2의 Options API에서 제공하던 `watch`와 유사한 컨셉을 가지고 있습니다. Vue 3에서 `Composition API`가 공식 도입되면서, 반응형 값(Reactive value)을 감지하기 위해 함께 제공됩니다.

> ※ Reactive value란?
> 참조 가능한 값(ref, reactive, computed 등)으로, 값을 변경하면 Vue가 변경 사항을 감지하고 해당 값을 참조하는 DOM과 반응형 값을 함께 업데이트합니다.

![참고 이미지](/images/posts/watch-watcheffect/image.png)

## 1. watch

```jsx
// main page
<script setup lang="ts">
const route = useRoute();

// 페이지 진입시 동작하지 않음
watch([route], (oldValue, newValue) => {
	window.alert(`현재 위치는 ${route.path}입니다.`);
})
</script>
```

`watch`는 두 개의 필수 인자와 한 개의 선택 인자를 받습니다. 첫 번째 인자는 감시할 source, 두 번째 인자는 source가 변경될 때 호출될 callback 함수입니다.

> ※ source에 들어갈 수 있는 요소들

    1) 구독할 값을 리턴하는 getter 함수 (예시 : ()=> ref.value)
    2) ref, reactive와 같은 반응형 값
    3) 1번과 2번 등을 포함한 배열

여러 반응형 값들 중 특정 값만 명시적으로 추적하거나, 변화 이전 값(`oldValue`)까지 확인해야 한다면 `watch`를 사용하는 것이 적합합니다. `watch`는 lazy한 특성 때문에 명시적으로 입력한 값이 변경될 때만 동작하고, 기본적으로는 mount 이후의 변경만 추적합니다. 앞서 언급한 이슈도 페이지가 mount되기 전에 route 값이 먼저 확정되면서 발생했습니다. mount 여부와 관계없이 특정 값을 즉시 확인하고 싶다면 `watchEffect`를 사용하거나, 아래에 정리한 세 번째 인자(옵션)를 사용하시면 됩니다.

> ※ 세 번째 인자에 들어갈 수 있는 요소들

1. immediate: watch가 생성되는 즉시 callback를 호출한다.
2. deep: source가 object인 경우, deep한 변경 사항에서도 callback을 호출한다.
3. flush: callback의 발생(flush) 타이밍을 조정할 때 사용되며 pre, post, sync 3가지 옵션이 존재한다. 각각 컴포넌트 업데이트 전, 업데이트 후, 동일한 틱 내에서 콜백 호출 여부를 지정한다.
4. onTrack / onTrigger: watch를 디버깅하는 callback 함수를 지정한다.

```jsx
// main page
<script setup lang="ts">
const route = useRoute();

// watch가 생성되는 즉시 동작
watch([route], (oldValue, newValue) => {
	window.alert(`현재 위치는 ${route.path}입니다.`);
}, { immediate: true })
</script>
```

`watchEffect`가 아니라 `watch`로 이번 이슈를 해결하려면, 세 번째 인자로 `immediate: true`를 넣어주시면 됩니다.

### watch 특징 정리

앞서 말한 `watch`의 특징을 정리하면 다음과 같습니다.

1. 필수 인자를 두 개, 선택 인자를 한 개 받는다.
2. 처음에 컴포넌트가 mount될때 실행되지 않는다.
3. 첫 번째 인자에 명시적으로 입력한 값들만 체크한다. 콜백 내에서 사용되는 다른 반응형 값들은 체크하지 않는다.

## 2. watchEffect

```jsx
// main page
<script setup lang="ts">
const route = useRoute();

// 생성되는 즉시 동작
watchEffect(() => {
	window.alert(`현재 위치는 ${route.path}입니다.`);
})
</script>
```

`watchEffect`는 `watch`와 달리 한 개의 필수 인자와 한 개의 선택 인자를 받습니다. 첫 번째 인자로 callback 함수를 받으며, 선언되는 즉시 함수 내부에서 사용되는 반응형 값들을 자동으로 추적합니다. 이후 `watchEffect` 외부 요인으로 해당 값들이 변경될 때마다 callback을 다시 실행합니다. 다만 mount되지 않은 DOM에 접근하면 오류가 날 수 있으니 주의가 필요합니다.
두 번째 인자는 선택 값이며 `watch`와 마찬가지로 아래 옵션을 사용할 수 있습니다.

> ※ 두 번째 인자에 들어갈 수 있는 요소들

1. flush: watch의 flush와 동일
2. onTrack / onTrigger: watch의 onTrack, onTrigger와 동일

### watchEffect 특징 정리

`watchEffect`의 특징을 정리하면 다음과 같습니다.

1. 필수 인자와 선택 인자를 각각 한 개씩 받는다.
2. 처음에 컴포넌트가 mount될때도 실행된다.
3. 콜백 함수에서 사용되는 반응형 값들을 모두 추적한다. 따라서 watch보다는 덜 명시적이다.

## 3. 결론

사실 일반적인 경우에는 `watch`나 `watchEffect` 어느 것을 사용하셔도 큰 차이는 없습니다. 다만 둘의 차이와 사용 목적을 명확히 해두면, 상황에 맞는 선택을 하기에 도움이 된다고 생각합니다.

### Watch를 사용하면 좋은 경우

1. 명시적으로 추적할 값을 선언하여 필요한 상황에서만 값을 추적하길 원하는 경우
2. 추적한 값의 old value를 보고 싶은 경우

### WatchEffect를 사용하면 좋은 경우

1. 명시적으로 특정 값만 추적하기 어려운 경우
2. 컴포넌트가 mount될때 바로 사용하고 싶은 경우

## 참고 자료

- [Vue’s watch vs watchEffect, which should I use?](https://www.vuemastery.com/blog/vues-watch-vs-watcheffect-which-should-i-use/)
- [Vue3 Composition API: WatchEffect Vs. Watch](https://blog.openreplay.com/vue3-composition-api-watcheffect-vs-watch/)
- [vue.js 공식 문서](https://vuejs.org/guide/essentials/watchers.html#watcheffect)
- [watch VS watchEffect in Vue 3 - Must Know Differences](https://www.webmound.com/watch-vs-watcheffect-vue-composition-api/)
